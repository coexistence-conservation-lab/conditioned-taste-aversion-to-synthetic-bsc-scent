---
title: "Inducing conditioned taste aversion in red foxes to bush stone-curlew eggs using synthetic scent"
author: "Ellie Lambden, Belinda Wilson"
date: "Mar 1, 2024"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 4
    toc_float:
      collapsed: false
    theme: united
    highlight: tango
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE, warning = FALSE, message = FALSE)
```

# Background

Major questions:

  1. Did we induce CTA in red foxes?
  2. How long did it take to induce CTA?
  3. Did we induce CTA in ravens?

# Data preparation

Firstly, we're going to install and load our packages. We will use the pacman [Package Management Tool](https://cran.r-project.org/web/packages/pacman/index.html) which allows us to install and load subsequent packages in a condensed and efficient way.

```{r, eval=FALSE}
# Install pacman package
install.packages('pacman')
```

```{r, results='hide', warning=FALSE, message=FALSE}
# Install and load required packages
pacman::p_load(dplyr, ggmap, ggspatial, ggplot2, janitor, lme4, 
               readxl, sf, sp, tidyverse, viridis)
```

Secondly, we'll read in our data and explore it.

```{r}
# Read in data
data <- read_excel(path="data.xlsx", sheet="data") %>%
  clean_names()
```

Let's view the data.

```{r, echo=FALSE, eval=FALSE}
#View(data)

# Look at first 6 rows of the data
head(data)

# Look at last 6 rows of the data
tail(data)

# Look at the structure of the data
str(data)

# Look at the column names
names(data)

# Look at the values of a single column
head(data$bait_take)

# Look at unique values for a single column
unique(data$treatment)
unique(data$bait_take)

# Find out how many rows there are in the data
nrow(data)
```

## Bait take

Now, we'll wrangle some of our data to get it ready for analyses and plotting.

```{r}
data <- read_excel(path="data.xlsx", sheet="data") %>%
  clean_names() %>%
  mutate(date = as.Date(date)) %>%
  mutate(bait_take = as.numeric(bait_take)) %>%
  mutate(phase = as.factor(phase)) %>%
  drop_na(bait_take) %>%
  mutate(bait_yes = ifelse(bait_take == 1, "Yes", "No"))
```

## Weather

The weather data were acquired from the [Australian Bureau of Meteorology weather station 70351](http://www.bom.gov.au/climate/dwo/202402/html/IDCJDW2801.202402.shtml).

```{r}
weather <- read_excel(path="data.xlsx", sheet="weather") %>%
  clean_names() %>%
  mutate(date = as.Date(date))

# Combine bait take and weather data into a single df
data <- left_join(data, weather, by=c("date"))
```

## Species

```{r}
# Subset to actual instances of bait take by a vertebrate
data <- data %>%
  subset(species != "Lizard") %>%
  mutate(fox_visited = ifelse(fox_visit_1 != 0, "Yes", 
                       ifelse(fox_visit_2 !=0, "Yes",
                       ifelse(fox_visit_3 !=0, "Yes", 
                       ifelse(fox_visit_4 !=0, "Yes", "No"))))) %>%
  
  mutate(fox_visits = ifelse(fox_visit_4 != 0, 4, 
                      ifelse(fox_visit_3 !=0, 3,
                      ifelse(fox_visit_2 !=0, 2, 
                      ifelse(fox_visit_1 !=0, 1, 0))))) %>%

  mutate(raven_visited = ifelse(raven_visit_1 != 0, "Yes", 
                         ifelse(raven_visit_2 !=0, "Yes",
                         ifelse(raven_visit_3 !=0, "Yes", "No")))) %>%
  
  mutate(raven_visits = ifelse(raven_visit_3 !=0, 3, 
                        ifelse(raven_visit_2 !=0, 2,
                        ifelse(raven_visit_1 !=0, 1, 0))))

write.csv(data, "data processed.csv")
```

# Analyses

## Bait take

### Plots

#### All species

Bait take by treatment

```{r}
# Read in processed data
data <- read.csv("data processed.csv") %>%
  clean_names() %>%
  mutate(date = as.Date(date))

# Plot by treatment type
bait_treat <- ggplot(data, aes(x = as.Date(date), 
                                           y = bait_take, 
                                           col=treatment, 
                                           fill=treatment)) +
  geom_smooth() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  ggtitle("All species") +
  xlab("Date") + 
  ylab("Bait take") + 
  labs(fill="Treatment", col="Treatment")

# Display the plot
print(bait_treat)

# Save the plot as a jpeg
ggsave("figures/bait_treat.jpeg", height=1500, width=2000, unit="px")
```

Bait take by treatment and phase

```{r}
# Read in processed data
data <- read.csv("data processed.csv") %>%
  clean_names() %>%
  mutate(date = as.Date(date))

# Plot by treatment type
bait_treat_phase <- ggplot(data, aes(x = as.Date(date), 
                                           y = bait_take, 
                                           col=treatment, 
                                           fill=treatment)) +
  geom_smooth() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  ggtitle("All species") +
  facet_wrap(~phase, scales="free") +
  xlab("Date") + 
  ylab("Bait take") + 
  labs(fill="Treatment", col="Treatment")

# Display the plot
print(bait_treat_phase)

# Save the plot as a jpeg
ggsave("figures/bait_treat_phase.jpeg", height=1500, width=2000, unit="px")
```

Percentage bait taken by each species by phase

```{r}
# Subset to only potential foxes
taken <- data %>%
  subset(bait_take != 0) %>%
  subset(species != "Not taken") %>%
  group_by(species, treatment, phase) %>%
  summarise(perc = n() / nrow(data) * 100)

# Plot by treatment type
taken_species_phase_hist <- ggplot(data=taken, 
                                        aes(x = species, y = perc, 
                                            col=treatment, fill=treatment)) +
  geom_col() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~phase) +
  ggtitle("All species") +
  xlab("Species") + 
  ylab("Percentage of taken baits (%)") + 
  labs(fill="Treatment", col="Treatment")

# Display the plot
print(taken_species_phase_hist)

# Save the plot as a jpeg
ggsave("figures/taken_species_phase_hist.jpeg", height=1500, width=2000, unit="px")
```

Plot bait take by rainfall

```{r}
# Plot by rainfall type
bait_rain <- ggplot(data, aes(x = rainfall_mm, 
                                          y = bait_take, 
                                          col=treatment, 
                                          fill=treatment)) +
  geom_smooth() + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  ggtitle("All species") +
  xlab("Rainfall") + 
  ylab("Bait take") + 
  labs(fill="Treatment", col="Treatment")
  
# Display the plot
print(bait_rain)

# Save the plot as a jpeg
ggsave("figures/bait_rain.jpeg", height=1500, width=2000, unit="px")
```

#### Foxes

Percentage fox visits by treatment and phase

```{r}
# Subset to only potential foxes
fox_stats <- data %>%
  subset(species == "Fox") %>%
  group_by(treatment, phase) %>%
  summarise(perc = n() / nrow(data) * 100)
  
# Plot by treatment type
visits_fox_histogram <- ggplot(data=fox_stats, 
                              aes(y = perc, x = treatment, 
                                  col=treatment, fill=treatment)) +
  geom_col() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~phase) +
  ggtitle("Potential fox visits (including unknowns)") +
  xlab("Species") + 
  ylab("Percentage of fox visits (%)") + 
  labs(fill="Treatment", col="Treatment")

# Display the plot
print(visits_fox_histogram)

# Save the plot as a jpeg
ggsave("figures/visits_fox_histogram.jpeg", height=1500, width=3000, unit="px")
```

```{r}
# Subset to only potential foxes
foxes_only <- data %>%
  subset(species != "Raven") %>%
  subset(species != "Unknown")
  
# Plot by treatment type
bait_treat_phase <- ggplot(data=foxes_only, aes(x = as.Date(date), 
                                           y = bait_take, 
                                           col=treatment, 
                                           fill=treatment)) +
  geom_smooth() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  ggtitle("Foxes vs no take (excluding unknowns)") +
  facet_wrap(~phase, scales="free") +
  xlab("Date") + 
  ylab("Bait take") + 
  labs(fill="Treatment", col="Treatment")

# Display the plot
print(bait_treat_phase)

# Save the plot as a jpeg
ggsave("figures/bait_foxes_treat_phase.jpeg", height=1500, width=3000, unit="px")
```

#### Ravens

Percentage fox visits by treatment and phase

```{r}
# Subset to only potential foxes
raven_stats <- data %>%
  subset(species == "Raven") %>%
  group_by(treatment, phase) %>%
  summarise(perc = n() / nrow(data) * 100)
  
# Plot by treatment type
visits_raven_hist <- ggplot(data=raven_stats, 
                              aes(y = perc, x = treatment, 
                                  col=treatment, fill=treatment)) +
  geom_col() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~phase) +
  ggtitle("Potential raven visits (including unknowns)") +
  xlab("Species") + 
  ylab("Percentage of raven visits (%)") + 
  labs(fill="Treatment", col="Treatment")

# Display the plot
print(visits_raven_hist)

# Save the plot as a jpeg
ggsave("figures/visits_raven_hist.jpeg", height=1500, width=3000, unit="px")
```

```{r}
# Subset to only potential foxes
ravens_only <- data %>%
  subset(species != "Fox") %>%
  subset(species != "Unknown")
  
# Plot by treatment type
bait_raven_treat_phase <- ggplot(data=ravens_only, aes(x = as.Date(date), 
                                           y = bait_take, 
                                           col=treatment, 
                                           fill=treatment)) +
  geom_smooth() +
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  ggtitle("Ravens vs no take (excluding unknowns)") +
  facet_wrap(~phase, scales="free") +
  xlab("Date") + 
  ylab("Bait take") + 
  labs(fill="Treatment", col="Treatment")

# Display the plot
print(bait_raven_treat_phase)

# Save the plot as a jpeg
ggsave("figures/bait_ravens_treat_phase.jpeg", height=1500, width=3000, unit="px")
```

Bait take by fox visits 

```{r}
# Plot bait take by species visits
bait_visits <- ggplot(data, mapping=aes(x = as.Date(date))) +
  geom_smooth(data, mapping=aes(y = as.numeric(bait_take)), 
              color = "red", fill = "red") +
  geom_smooth(data, mapping=aes(y = as.numeric(fox_visits)), 
              color = "darkorange", fill = "darkorange")  +
  geom_smooth(data, mapping=aes(y = as.numeric(raven_visits)), 
              color = "black", fill = "black")  +
  theme_minimal() + 
  facet_wrap(~treatment) +
  scale_y_continuous(name = "Bait take (%)", limits = c(0, 1), 
                     sec.axis = sec_axis(~., name = "Fox (orange) and raven (black) visits", 
                                         breaks = c(0, 1))) +
  xlab("Date")

# Display the plot
print(bait_visits)

# Save the plot as a jpeg
ggsave("figures/bait_visits.jpeg", height=1500, width=2000, unit="px")
```

### Models

#### All species

Build generalised linear models for our research questions.

```{r}
# Model for bait take by treatment
summary(glm(bait_take ~ treatment, data=data))

# Model for bait take by treatment and rainfall
summary(glm(bait_take ~ treatment + rainfall_mm, data=data))

# Model for bait take by treatment and phase
summary(glm(bait_take ~ treatment + phase, data=data))

# Model for bait take by treatment and phase
summary(glm(bait_take ~ treatment + site, data=data))
```

#### Foxes

```{r}
# Do fox visits change with treatment or phase?
summary(glm(fox_visits ~ treatment + phase + 
              rainfall_mm + maximum_temperature_c, data=data))
```

#### Ravens

```{r}
# Model for visits against treatment and phase
summary(glm(raven_visits ~ treatment + phase + 
              rainfall_mm + maximum_temperature_c, data=data))
```

## GIS

### Map responses

Here we map our responses of `bait_take`, `fox_visits`, and `raven_visits` across Ginninderry Conservation Corridor.

```{r}
# Use Google API to fetch a base map
# ggmap::register_google(key="[add API key here]", write=TRUE)
map <- get_map(location=c(lon=148.9811, lat=-35.2350),
               zoom=15, source="google", maptype="satellite", crop=FALSE)
```

```{r}
# Read in shapefile
gis <- st_read("shapefiles/bait_stations_egg_cta.shp") %>%
  fortify() %>%
  clean_names() %>%
  rename(site=name)

# Map the bait stations
gin_map <- ggmap(map) + 
  geom_point(data=gis, size=2, aes(x=long, y=lat, col=treatment)) + 
  theme_minimal() +
  xlab("") + ylab("") + labs(col="Treatment")

# Display the plot
print(gin_map)
```

```{r}
# Combine the bait take df with the GIS df
data <- left_join(data, gis, by="site")

# Generalised linear model
mod <- glm(bait_take ~ lat + long + elevation, data=data)
summary(mod)

# Map the bait stations
mod_map <- ggmap(map) + 
  geom_point(data=data, shape=21, size=2, stroke=1, col="white", alpha=0.2,
             aes(x=long, y=lat, fill=bait_take)) + 
  theme(axis.text.x=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.ticks.y=element_blank(), 
        plot.title=element_text(hjust=0.5),
        strip.background=element_rect(fill="#363842"), 
        strip.text=element_text(colour="white")) +
  facet_wrap(~phase) +
  scale_fill_viridis_c() +
  xlab("") + ylab("") + ggtitle("Phase") + labs(fill="Bait take")

# Display the plot
print(mod_map)
```

```{r, echo=FALSE}
# Save the plot as a jpeg
ggsave(plot=mod_map, "figures/bait take map.jpeg", height=4, width=6, dpi=300)
```

```{r}
# Map the fox visitation
mod_map <- ggmap(map) + 
  geom_point(data=data, shape=21, size=2, stroke=1, col="white", alpha=0.2,
             aes(x=long, y=lat, fill=fox_visits)) + 
  theme(axis.text.x=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.ticks.y=element_blank(), 
        plot.title=element_text(hjust=0.5),
        strip.background=element_rect(fill="#363842"), 
        strip.text=element_text(colour="white")) +
  facet_wrap(~phase) +
  scale_fill_viridis_c() +
  xlab("") + ylab("") + ggtitle("Phase") + labs(fill="Fox visits")

# Display the plot
print(mod_map)
```

```{r, echo=FALSE}
# Save the plot as a jpeg
ggsave(plot=mod_map, "figures/fox visits map.jpeg", height=4, width=6, dpi=300)
```

```{r}
# Map the fox visitation
mod_map <- ggmap(map) + 
  geom_point(data=data, shape=21, size=2, stroke=1, col="white", alpha=0.2,
             aes(x=long, y=lat, fill=raven_visits)) + 
  theme(axis.text.x=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.ticks.y=element_blank(), 
        plot.title=element_text(hjust=0.5),
        strip.background=element_rect(fill="#363842"), 
        strip.text=element_text(colour="white")) +
  facet_wrap(~phase) +
  scale_fill_viridis_c() +
  xlab("") + ylab("") + ggtitle("Phase") + labs(fill="Raven visits")

# Display the plot
print(mod_map)
```

```{r, echo=FALSE}
# Save the plot as a jpeg
ggsave(plot=mod_map, "figures/raven visits map.jpeg", height=4, width=6, dpi=300)
```

### Calculate influence of spatial features on responses

Here we read in, project, and map the bait stations across Ginninderry Conservation Corridor using shapefiles for Ginninderry's boundaries, roads, tracks, vegetation, and waterbodies.

```{r}
# Road layers
gcc_roads <- st_read("shapefiles/i5516_roads.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:4283") %>%
  st_transform("EPSG:4326")

gcc_tracks <- st_read("shapefiles/i5516_foottracks.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:4283") %>%
  st_transform("EPSG:4326")

# Hand drawn layers :)
gcc_hd <- st_read("shapefiles/x.shp")
st_crs(gcc_hd)
gcc_hd <- st_read("shapefiles/x.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:4283") %>%
  st_transform("EPSG:4326")

# Development layers
construct <- st_read("shapefiles/gcc_construction_area.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:7844") %>%
  st_transform("EPSG:4326")

# Vegetation layers
gcc_veg <- st_read("shapefiles/i5516_nativevegetationareas.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:4283") %>%
  st_transform("EPSG:4326")

act_nvis <- st_read("shapefiles/ACT_NVIS_6.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:4283") %>%
  st_transform("EPSG:4326") %>%
  clean_names()

# Water layers
gcc_pond <- st_read("shapefiles/i5516_pondageareas.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:4283") %>%
  st_transform("EPSG:4326")

gcc_wcl <- st_read("shapefiles/i5516_watercourselines.shp") %>%
  # Set projection using sf
  st_set_crs("EPSG:4283") %>%
  st_transform("EPSG:4326")

# Read in bait station points
stations <- st_read("shapefiles/bait_stations_egg_cta.shp") %>%
  as.data.frame() %>%
  fortify() %>%
  clean_names()

# Read in bait station points
stations_spdf <- SpatialPointsDataFrame( 
  data.frame(stations$long, stations$lat), 
  stations, proj4string=CRS("EPSG:4326")) %>% 
  st_as_sf()

# Print bounding box coordinates for GCC
st_bbox(stations_spdf)

# Save coordinates
xmin <- st_bbox(stations_spdf)[[1]]-0.01
xmax <- st_bbox(stations_spdf)[[3]]+0.01
ymin <- st_bbox(stations_spdf)[[2]]-0.01
ymax <- st_bbox(stations_spdf)[[4]]+0.01
```

```{r}
# Map the site
gin_map_cons <- ggplot() + 
  #geom_sf(data=gcc_roads, col="darkred") + 
  #geom_sf(data=gcc_tracks, col="darkorange") + 
  #geom_sf(data=construct, fill="yellow") + 
  #geom_sf(data=gcc_veg, fill="darkgreen") + 
  geom_sf(st_zm(act_nvis), mapping=aes(fill=mvg_name), 
          col="grey30", lwd=0.5, alpha=0.8) + 
  #geom_sf(data=gcc_pond, col="darkblue") + 
  #geom_sf(data=gcc_wcl, col="blue") + 
  geom_sf(data=stations_spdf) + 
  coord_sf(xlim = c(xmin, xmax), ylim = c(ymin, ymax)) +
  theme_minimal() +
  scale_fill_manual(values=viridis(18, begin=0.9, end=0.1)) +
  xlab("") + ylab("") + labs(col="Treatment")

# Display the plot
print(gin_map_cons)
```

```{r}
install.packages("bomrang")
```